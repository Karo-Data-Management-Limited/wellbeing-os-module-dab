name: Build and Publish DAB to GitHub Container Registry

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  MODULE_NAME: 'wellbeing-os-data-api'

jobs:
  build-and-publish-dab:
    name: Build and Push DAB to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Aspire CLI
        shell: pwsh
        run: |
          iex "& { $(irm https://aspire.dev/install.ps1) }"

      - name: Setup CI config files
        run: |
          # Use CI-specific configs for GitHub Actions
          cp .github/nuget.config nuget.config || echo "Using existing nuget.config"

      - name: Build Data API Builder with Aspire
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASPIRE_DATABASE_TYPE: mssql
        run: |
          aspire do build-wellbeing-os-data-api --log-level debug

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push to GHCR
        run: |
          # Convert repository owner to lowercase for Docker registry compatibility
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          MODULE_NAME="${{ env.MODULE_NAME }}"
          GHCR_REPO="ghcr.io/${REPO_OWNER_LOWER}/${MODULE_NAME}"
          IMAGE_TAG="${{ github.sha }}"
          
          # Find the image built by Aspire (it uses a hash-based tag)
          ASPIRE_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${MODULE_NAME}:" | head -n 1)
          
          if [ -z "$ASPIRE_IMAGE" ]; then
            echo "Error: No Aspire-built image found for ${MODULE_NAME}"
            docker images
            exit 1
          fi
          
          echo "Found Aspire image: $ASPIRE_IMAGE"
          echo "Tagging and pushing ${MODULE_NAME}:$IMAGE_TAG to GHCR..."
          docker tag $ASPIRE_IMAGE $GHCR_REPO:$IMAGE_TAG
          docker tag $ASPIRE_IMAGE $GHCR_REPO:latest
          docker push $GHCR_REPO:$IMAGE_TAG
          docker push $GHCR_REPO:latest
          
          echo "âœ… Successfully published to GitHub Container Registry"
          echo "Image: $GHCR_REPO:$IMAGE_TAG"
